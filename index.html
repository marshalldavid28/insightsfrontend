<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Campaign Insight Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      padding: 2rem;
      max-width: 720px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    form {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    label {
      font-weight: 500;
      margin: 1rem 0 0.5rem;
      display: block;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background-color: #0071e3;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      font-weight: normal;
    }
    .checkbox-group input {
      margin-right: 6px;
      width: auto;
    }
    textarea[readonly] {
      background: #f3f3f3;
    }
  </style>
</head>
<body>

<h1>üìä Campaign Insights Generator</h1>

<form id="insightForm">
  <label>Upload DV360 Excel File</label>
  <input type="file" name="file" id="fileInput" required />

  <label>Campaign Objective</label>
  <input type="text" name="objective" required />

  <label>CTR Target (%)</label>
  <input type="number" step="0.01" name="ctr_target" required />

  <label>CPM Target (SGD)</label>
  <input type="number" step="0.01" name="cpm_target" required />

  <label>Total Budget (SGD)</label>
  <input type="number" step="0.01" name="budget" required />

  <label>Flight Start Date</label>
  <input type="date" name="flight_start" required />

  <label>Flight End Date</label>
  <input type="date" name="flight_end" required />

  <label>Primary Metric</label>
  <select name="primary_metric" required>
    <option value="CTR">CTR</option>
    <option value="CPM">CPM</option>
    <option value="Conversions">Conversions</option>
    <option value="CPC">CPC</option>
    <option value="Cost per Conversion">Cost per Conversion</option>
  </select>

  <label>Secondary Metric (Optional)</label>
  <select name="secondary_metric">
    <option value="">None</option>
    <option value="CTR">CTR</option>
    <option value="CPM">CPM</option>
    <option value="Conversions">Conversions</option>
    <option value="CPC">CPC</option>
    <option value="Cost per Conversion">Cost per Conversion</option>
  </select>

  <div id="groupOptionsContainer" style="display:none;">
    <label>Breakdowns to Include</label>
    <div class="checkbox-group" id="groupCheckboxes"></div>
  </div>

  <button type="submit">Generate Insights</button>
</form>

<h2>üìÑ Output</h2>
<textarea id="output" rows="18" readonly placeholder="Your insights will appear here..."></textarea>

<script>
  const form = document.getElementById("insightForm");
  const fileInput = document.getElementById("fileInput");
  const groupOptions = document.getElementById("groupOptionsContainer");
  const groupCheckboxes = document.getElementById("groupCheckboxes");
  const output = document.getElementById("output");

  let availableColumns = [];

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    // Ping the server to get the column names
    const res = await fetch("https://madsapiens-report-backend.onrender.com/preview-columns/", {
      method: "POST",
      body: formData,
    });

    const data = await res.json();
    if (data.columns) {
      groupCheckboxes.innerHTML = "";
      data.columns.forEach(col => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "groupings";
        checkbox.value = col;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(col));
        groupCheckboxes.appendChild(label);
      });
      groupOptions.style.display = "block";
    } else {
      groupOptions.style.display = "none";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    output.value = "‚è≥ Generating insights...";

    const formData = new FormData(form);
    const start = form.elements['flight_start'].value;
    const end = form.elements['flight_end'].value;
    formData.set("flight", `${start} to ${end}`);

    // Add selected groupings
    const selected = [...groupCheckboxes.querySelectorAll("input:checked")].map(cb => cb.value);
    formData.append("selected_groupings", JSON.stringify(selected));

    try {
      const res = await fetch("https://madsapiens-report-backend.onrender.com/generate-insights/", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      if (data.report) {
        output.value = data.report;
      } else {
        output.value = "‚ö†Ô∏è Something went wrong.\n\n" + JSON.stringify(data, null, 2);
      }
    } catch (err) {
      output.value = "‚ùå Failed to reach backend.\n\n" + err.message;
    }
  });
</script>

</body>
</html>
